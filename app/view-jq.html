<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>FTG Exercises</title>

<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<style type="text/css">
body, table td, select, button {
  font-family: Arial Unicode MS, Arial, sans-serif;
  /* font-size: small; */
}
body {
	font-size: medium;
}
.pad5{
	padding-left: 2em;
	padding-right: 3em;
}
</style>


<script src="https://code.jquery.com/jquery-2.0.3.min.js"></script>
<script	src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore.js"></script>
<script	src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.12.0/js-yaml.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

</head>

<body>
	<img src="gwt/ajax-loader.gif" id="loadingIndicator" style="position: absolute;left: 50%; top:50%"></img>

	<script type="text/javascript">
		var main = function() {
			var dbLocation = 'db/'; //relative
			//absolute:
			dbLocation = 'https://csabakoncz.github.io/ftg-data/db/';

		    var exId = location.search.replace('?','')

			downloadDirectly(exId,success);
			downloadThroughExref(exId, success);

			function success(object){
				exercise=object
				document.title=object.get('title')

				var style=$('<style type="text/css"></style>')

				//does not work, the style needs first to be fetched
				var exStyle=object.get('style').get('content')
				style.html(exStyle)
				$('head').append(style)

				var puzzleDiv = $('<div id="text" style="display: none;"></div>')
				puzzleDiv.html(object.get('content'))
				$('body').append(puzzleDiv)

				var template = _.template(object.get('template').get('content'))
				var templateResultDOM=$(template(object))
				$('body').append(templateResultDOM)

			    // gwtBootStrap=$('<script type="text/javascript" language="javascript" src="../app/gwt/ftg/ftg.nocache.js" />')
				// $('body').append(gwtBootStrap)

				createPuzzle()
			}

			function createPuzzle(){
				var choiceReg=/#([^#]*)#/g
				var exText=$('#text')[0].innerText
				var choices = exText.match(choiceReg).map(function(choice){
					//strip the hashmarks:
					var res = /^#([^#]*)#$/.exec(choice)
					// console.log(choice,res)
					return res[1];
				})

				choices.forEach( function(m){
					var choiceE = $('<span class="choice choiceWord correctWord">'+m+'</span>')
					$('#choicesPanel').append(choiceE)
				});

				$('#choicesPanel').droppable({
					accept: '.guess',
					drop: function(event, ui){
						ui.draggable.data('originalGuess').css({visibility:'', top: '0px', left: '0px'})
						ui.draggable.data('owner').addClass('pad5')
						ui.draggable.remove()
					}
				})

				$('.choice').draggable({
					revert: 'invalid',
					cursor: 'crosshair'
				})

				var puzzleText = exText.replace(choiceReg,'<span class="gapPanel pad5"></span>')
				$('#puzzleArea').html(puzzleText)
				$('.gapPanel').droppable({
					drop: function(event, ui){
						$(this).removeClass('pad5')

						var originalGuess = ui.draggable.data('originalGuess')
						var dropped = originalGuess || ui.draggable

						$(this).find('.guess').remove()
						var guess=$('<span class="correctWord guess"></span>')
						guess.html(dropped.html())
						guess.data('originalGuess', dropped)
						guess.data('owner', $(this))
						$(this).append(guess)
						guess.draggable({
							revert: 'invalid',
							cursor: 'crosshair'
						})

						var oldGuess = $(this).data('guess')
						if(oldGuess){
							oldGuess.css({visibility:'', top: '0px', left: '0px'})
						}
						$(this).data('guess', dropped)
						dropped.css({visibility:'hidden'})
						if(originalGuess){
							//restore the dashes on the owner:
							ui.draggable.data('owner').addClass('pad5')
							//this is something that has already been dropped, delete it
							ui.draggable.remove()
						}
					}
				})
			}

			$('#title').append($('<h1>Exercises</h1>')[0])

			function downloadThroughExref(linkId, success){
			    getEntity('link',linkId).then(function(link){
			        var exId = link._ref.split('/')[1];
			        downloadDirectly(exId, success);
			    });
			}

			function getEntity(type, id){
			    return getDB(type+'/'+id);
			}

			function withExtension(id){
				if(id.split('.').length > 1){
					return  id;
				}
				else{
					// return id+'.json';
					return id+'.yaml';
				}
			}

			function getDB(ref){
				var uri = dbLocation + withExtension(ref)

			    return $.get(uri).then(function(dbValue){
					if(isYaml(uri) && typeof dbValue == 'string'){
						return jsyaml.load(dbValue)
					}
					else{
						return dbValue
					}
				});
			}

			function isYaml(uri){
				return /\.yaml$/.test(uri)
			}

			function getExcercise(id){
			    return getEntity('exercise', id);
			}

			var ParseObject = {
				get: function(what){
				    return this[what];
				}
			}

			function createParseObject(src){
			    var po = Object.create(ParseObject);
			    _.extend(po,src);
			    return po;
			}

			function downloadDirectly(exId, successCb){
			    getExcercise(exId)
			    .then(function(data){
			        return $.when(data,getDB(data.template._ref),getDB(data.style._ref))
			    })
			    .then(function (exercise, template, style){
			        exercise = createParseObject(exercise);
			        template = createParseObject(template);
			        style = createParseObject(style);

			        exercise.template=template;
			        exercise.style=style;

			        success(exercise)
			    });
			}
		}
		$(main)
	</script>
</body>

</html>
